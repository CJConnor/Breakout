<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Game</title>
        <link rel="stylesheet" type="text/css" href="css/app.css" />
        <link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
    <body>
    
        <div class="header">
            
            <h1>The Breakout Game</h1>

        </div>

        <div class="content">

            <div class="canvasDiv">

                <h2>Press the space bar to play or pause</h2>

                <canvas id="myCanvas" width="480" height="320"></canvas>

            </div>
        
            <!--LeaderBoard Table-->
            <table>
                <thead>
                    <tr>
                        <th colspan="2">LeaderBoard</th>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="table" >
                   
                </tbody>
            </table>

        </div>

        <!--Congrats Modal Start-->
        <div id="con-modal" class="con-modal">

                <div class="con-modal-content" id="con-modal-content">
            
                    <div class="con-modal-header">
            
                        <span class="close" onclick="closeCongratsModal();">&times;</span>
            
                        <h1>Congratulations, you have beat the game!!</h2>
            
                      </div>
            
                      <div class="con-modal-body">
            
                        <h2>Enter your name to save it to the leaderboard!</h2>
            
                        <form action="#">
            
                            <input type="text" name="name" id="name" />
            
                        </form>
            
                      </div>
            
                      <div class="con-modal-footer">
            
                        <button type="submit" onclick="saveResult();">Save</button>
            
                      </div>
                </div>
                
            </div>
            <!--Congrats Modal End-->
       

        <script>
            //Setting The Canvas
            

            var canvas = document.getElementById("myCanvas");
            var ctx = canvas.getContext("2d");

            var x = canvas.width/2;
            var y = canvas.height-30;
            var dx = 2;
            var dy = -2;

            //Ball Variables
            var ballRadius = 10;

            //Paddle Variables
            var paddleHeight = 10;
            var paddleWidth = 75;
            var paddleX = (canvas.width - paddleWidth/2);

            //Key Board Control Variables
            var rightPressed = false;
            var leftPressed = false;

            //Brick Variables
            var brickRowCount = 3;
            var brickColumnCount = 5;
            var brickWidth = 75;
            var brickHeight = 20;
            var brickPadding = 10;
            var brickOffsetTop = 30;
            var brickOffsetLeft = 30;
            var bricks = [];

            //Game Mechanic Variables
            var score = 0;
            var lives = 3;
            var gameStop = true;

            //Bricks Array
            for(var c = 0; c < brickColumnCount; c++) {

                bricks[c] = [];

                for(var r = 0; r < brickRowCount; r++) {

                    bricks[c][r] = { x: 0, y: 0, status: 1 };

                }
            }

            //Draw Ball Function
            function drawBall() {

                ctx.beginPath();
                ctx.arc(x, y, ballRadius, 0, Math.PI*2);
                ctx.fillStyle = "#0095DD";
                ctx.fill();
                ctx.closePath();

            }

            //Draw Paddle Function
            function drawPaddle() {

                ctx.beginPath();
                ctx.rect(paddleX, canvas.height-paddleHeight, paddleWidth, paddleHeight);
                ctx.fillStyle = "#0095DD";
                ctx.fill();
                ctx.closePath();

            }


            //Draw Bricks Function
            function drawBricks() {

                for(var c = 0; c < brickColumnCount; c++) {

                    for(var r = 0; r < brickRowCount; r++) {

                        if(bricks[c][r].status == 1) {

                            var brickX = (c * (brickWidth + brickPadding)) + brickOffsetLeft;
                            var brickY = (r * (brickHeight + brickPadding)) + brickOffsetTop;
                            bricks[c][r].x = brickX;
                            bricks[c][r].y = brickY;
                            ctx.beginPath();
                            ctx.rect(brickX, brickY, brickWidth, brickHeight);
                            ctx.fillStyle = "#0095DD";
                            ctx.fill();
                            ctx.closePath();

                        }

                    }

                }

            }

            //Main Draw Function
            function draw() {

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawBricks();
                drawBall();
                drawPaddle();
                drawScore();
                drawLives();
                collisionDetection();

                x += dx;
                y += dy;

                //Makes sure the ball bounces off canvas walls
                if (x + dx > canvas.width-ballRadius || x + dx < ballRadius) {

                    dx = -dx;

                }

                //Makes sure the ball bounces off the ceiling and takes a life if it hits the floor
                if (y + dy < ballRadius) {

                    dy = -dy;

                } else if(y + dy > canvas.height - ballRadius) {

                    if(x > paddleX && x < paddleX + paddleWidth) {

                        dy = -dy;

                    } else {

                        lives--;

                        if(!lives) {

                            alert("Game Over");
                    
                            document.location.reload();

                        } else {

                            x = canvas.width/2;
                            y = canvas.height - 30;
                            dx = 2;
                            dy = -2;
                            paddleX = (canvas.width-paddleWidth)/2;

                        }

                        

                    }

                }

                //Moves Paddle Based on arrow keys
                if(rightPressed && paddleX < canvas.width - paddleWidth) {

                    paddleX += 7;

                } else if(leftPressed && paddleX > 0) {

                    paddleX -= 7;

                }

                //Animates the game
                if(gameStop == false) {
                    requestAnimationFrame(draw);
                }
                

            }

            //listens for buttons pressed and mouse movement
            document.addEventListener("keydown", keyDownHandler, false);
            document.addEventListener("keyup", keyUpHandler, false);
            document.addEventListener("keypress", pauseGame, false);
            document.addEventListener("mousemove", mouseMoveHandler, false);

            //Start Game
            function pauseGame(e) {

                if(e.keyCode == 32 && gameStop == true) {

                    gameStop = false;
                    
                } else if(e.keyCode == 32 && gameStop == false) {

                    gameStop = true;

                }
                draw();
            }


            //Moves paddle based on mouse coords
            function mouseMoveHandler(e) {

                var relativeX = e.clientX - canvas.offsetLeft;

                if(relativeX > 0 && relativeX < canvas.width) {

                    paddleX = relativeX - paddleWidth/2;

                }

            }

            //Moves paddle left based on arrow keys
            function keyDownHandler(e) {

                if(e.keyCode == 39) {

                    rightPressed = true;

                } else if (e.keyCode == 37) {

                    leftPressed = true;

                }

            }

            //Moves paddle right based on arrow keys
            function keyUpHandler(e) {

                if(e.keyCode == 39) {

                    rightPressed = false;

                } else if(e.keyCode == 37) {

                    leftPressed = false;

                }

            }

            //Detects collisions with bricks
            function collisionDetection() {
                
                for( var c = 0; c < brickColumnCount; c++) {

                    for(var r = 0; r < brickRowCount; r++) {

                        var b = bricks[c][r];

                        if(b.status == 1) {

                            if(x > b.x && x < b.x + brickWidth && y > b.y && y < b.y + brickHeight) {

                                dy = -dy;
                                b.status = 0;
                                score++;

                                if(score == brickRowCount*brickColumnCount) {

                                    displayCongratsModal();

                                }

                            }

                        }

                    }

                }

            }

            //Draws Score
            function drawScore() {

                ctx.font = "16px Arial";
                ctx.fillStyle = "#0095DD";
                ctx.fillText("Score: " + score, 8, 20);

            }

            //Draw Lives
            function drawLives() {

                ctx.font = "16px Arial";
                ctx.fillStyle = "#0095DD";
                ctx.fillText("Lives: " + lives, canvas.width - 65, 20);

            }

            function displayCongratsModal() {

                gameStop = true;
                document.getElementById("con-modal").style.display = "block";

            }

            function closeCongratsModal() {

                document.getElementById("con-modal").style.display = "none";
                displayResults();
                document.location.reload();

            }

            function displayResults() {

                $.get("php/displayResults.php", function(data){

                    var table = document.getElementById("table");

                    table.innerHTML = data;

                });

            }

            //AJAX Request

             function saveResult() {

                 var name = document.getElementById("name").value;

                $.post("php/saveResults.php",
                {
                    name: name,
                    score: score
                },
                    function(data, status){
                    //alert("Data: " + data);
                });

                closeCongratsModal();
                
             }


            //Calls Draw Function
            draw();
            $("body").load(displayResults());
        </script>

    </body>

</html>